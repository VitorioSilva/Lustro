name: Validate and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate code structure
      run: |
        echo "ğŸ” Validando estrutura do cÃ³digo..."
        
        # Testar imports crÃ­ticos
        python -c "
        print('1. ğŸ”§ Testando imports...')
        try:
            from app import create_app, db
            from app.utils.security import validate_email, validate_password_strength, validate_name
            from app.models import User, Veiculo, Servico, Agendamento
            print('âœ… Todos os imports funcionam')
        except ImportError as e:
            print(f'âŒ Erro de import: {e}')
            exit(1)
        
        print('2. ğŸ§ª Testando validaÃ§Ãµes...')
        # Testar validaÃ§Ã£o de email Gmail
        is_valid, msg = validate_email('teste@gmail.com')
        assert is_valid == True, 'Email Gmail deve ser vÃ¡lido'
        print('âœ… Email Gmail vÃ¡lido')
        
        # Testar validaÃ§Ã£o de email nÃ£o Gmail
        is_valid, msg = validate_email('teste@yahoo.com')
        assert is_valid == False, 'Email nÃ£o Gmail deve ser invÃ¡lido'
        print('âœ… Email nÃ£o Gmail bloqueado')
        
        # Testar validaÃ§Ã£o de senha forte
        is_valid, msg = validate_password_strength('SenhaForte123!')
        assert is_valid == True, 'Senha forte deve passar'
        print('âœ… Senha forte aceita')
        
        # Testar validaÃ§Ã£o de senha fraca
        is_valid, msg = validate_password_strength('12345678')
        assert is_valid == False, 'Senha sequencial deve falhar'
        print('âœ… Senha sequencial bloqueada')
        
        print('3. ğŸ—ï¸ Testando criaÃ§Ã£o do app...')
        app = create_app()
        with app.app_context():
            print('âœ… App Flask criado com sucesso')
        
        print('ğŸ‰ TODAS AS VALIDAÃ‡Ã•ES PASSARAM!')
        "

  deploy-notification:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to Vercel
      run: |
        echo 'âœ… ValidaÃ§Ãµes passaram! Vercel farÃ¡ deploy automÃ¡tico.'
        echo 'ğŸŒ Seu backend estarÃ¡ disponÃ­vel em: https://lustro-black.vercel.app'